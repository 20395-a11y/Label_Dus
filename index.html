<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generator Label Koli 3 Size</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root{
  --bg:#f7f2f6;--card:#fff;--text:#000;
}
body.dark{
  --bg:#121212;--card:#1e1e1e;--text:#fff;
}
body{
  background:var(--bg);
  color:var(--text);
  font-family:'Segoe UI',sans-serif;
}
.container{
  max-width:1000px;
  margin:20px auto;
  background:var(--card);
  padding:20px;
  border-radius:12px;
  box-shadow:0 5px 15px rgba(0,0,0,.1);
}
.table-scroll{max-height:320px;overflow:auto;}
thead th{position:sticky;top:0;background:var(--card);z-index:2;}

.badge-koli18{background:#0d6efd;}
.badge-plastic{background:#ffc107;}
.badge-sisa{background:#198754;color:#000;}

.summary-item{
  padding:6px 12px;
  border-radius:20px;
  font-size:14px;
  font-weight:500;
}
</style>
</head>

<body>
<div class="container">

<div class="d-flex align-items-center justify-content-center mb-3 position-relative">
  <button class="btn btn-secondary position-absolute start-0" onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>
  <h3 class="text-center m-0">üì¶ Generator Label Koli 3 Size</h3>
</div>

<div class="d-flex flex-wrap gap-2 mb-3">
  <button class="btn btn-dark" id="toggleInputMode">Mode TXT</button>
  <button class="btn btn-success" onclick="fileInput.click()">Upload File</button>
  <button class="btn btn-info btn-custom" id="downloadTemplate">Unduh Template</button>
  <button class="btn btn-primary" onclick="generateWithPlastic()">With Plastic Koli</button>
  <button class="btn btn-warning" onclick="generateWithoutPlastic()">Tanpa Plastic Koli</button>
  <button class="btn btn-info" onclick="exportExcel()">Export Excel</button>
  <button class="btn btn-danger" onclick="resetAll()">Reset</button>
</div>

<input type="file" id="fileInput" accept=".xlsx,.xls,.csv,.txt,.ods" hidden>

<div id="txtInputDiv" style="display:none">
<textarea id="txtInput" rows="5" class="form-control mb-3" placeholder="ALOKASI A,10,5,8&#10;ALOKASI B,7,2,0"></textarea>
</div>

<div id="tableInputDiv" class="table-scroll mb-3">
<table class="table table-bordered">
<thead class="table-primary">
<tr>
  <th>Alokasi</th>
  <th width="80">Qty M</th>
  <th width="80">Qty L</th>
  <th width="80">Qty XL</th>
</tr>
</thead>
<tbody>
<tr>
  <td><input class="form-control"></td>
  <td><input type="number" class="form-control "></td>
  <td><input type="number" class="form-control"></td>
  <td><input type="number" class="form-control"></td>
</tr>
</tbody>
</table>
</div>

<div class="btn_tambah">
<button class="btn btn-outline-primary mb-3" onclick="addTableRow()">‚ûï Tambah Baris</button>
</div>

<div class="table-scroll">
<table class="table table-bordered" id="resultTable">
<thead></thead>
<tbody></tbody>
</table>
</div>

<div id="summaryBox" class="mt-3 p-3 rounded shadow-sm" style="display:none;">
<h6 class="fw-bold">üìä Summary Packing</h6>
<div id="summaryContent" class="d-flex flex-wrap gap-2"></div>
</div>

</div>

<script>
let mode='table', lastMode=null;
const txtInput=document.getElementById('txtInput');
const tableInputDiv=document.getElementById('tableInputDiv');
const txtInputDiv=document.getElementById('txtInputDiv');
const toggleInputBtn=document.getElementById('toggleInputMode');
const fileInput=document.getElementById('fileInput');

function toggleTheme(){document.body.classList.toggle('dark');}

toggleInputBtn.onclick=()=>{
  if(mode==='table'){
    tableInputDiv.style.display='none';
    txtInputDiv.style.display='block';
    toggleInputBtn.textContent='Mode Table';
    mode='txt';
  }else{
    tableInputDiv.style.display='block';
    txtInputDiv.style.display='none';
    toggleInputBtn.textContent='Mode TXT';
    mode='table';
  }
};

function getInputRows(){
  let rows=[];
  if(mode==='table'){
    document.querySelectorAll('#tableInputDiv tbody tr').forEach(r=>{
      let alokasi = r.cells[0].querySelector('input').value.trim();
      let qtyM = parseInt(r.cells[1].querySelector('input').value)||0;
      let qtyL = parseInt(r.cells[2].querySelector('input').value)||0;
      let qtyXL = parseInt(r.cells[3].querySelector('input').value)||0;

      if(alokasi && (qtyM>0 || qtyL>0 || qtyXL>0)){
        rows.push({alokasi, qty: {M:qtyM, L:qtyL, XL:qtyXL}});
      }
    });
  } else {
txtInput.value.trim().split(/\n/).forEach(l => {
  let p = l.split(',');
  if(p[0]) {
    rows.push({
      alokasi: p[0].trim(),
      qty: { 
        M: parseInt(p[1] || 0), 
        L: parseInt(p[2] || 0), 
        XL: parseInt(p[3] || 0) 
      }
    });
  }
});
  }
  return rows;
}

function calcWithPlastic(q){
  let k18=Math.floor(q/18);
  let s=q%18;
  let p5=Math.floor(s/5);
  s=s%5;
  return{
    k18,p5,
    sisa:s>0?1:0,
    qk18:k18*18,
    qp5:p5*5,
    qs:s
  };
}
function calcWithoutPlastic(q){
  let k18=Math.floor(q/18);
  let s=q%18;
  return{
    k18,
    sisa:s>0?1:0,
    qk18:k18*18,
    qs:s
  };
}

function renderHeader(type){
  const t=document.querySelector('#resultTable thead');
  t.innerHTML = type==='with' ?
`<tr class="table-primary">
<th>Alokasi (Size)</th>
<th>Total Qty</th>
<th>Koli 18</th>
<th>Plastic 5</th>
<th>Koli Sisa</th>
<th>Qty Koli 18</th>
<th>Qty Plastic</th>
<th>Qty Sisa</th>
</tr>` :
`<tr class="table-primary">
<th>Alokasi (Size)</th>
<th>Total Qty</th>
<th>Koli 18</th>
<th>Koli Sisa</th>
<th>Qty Koli 18</th>
<th>Qty Sisa</th>
</tr>`;
}

function generateWithPlastic(){
  lastMode='with'; renderHeader('with');
  const tb=document.querySelector('#resultTable tbody');
  tb.innerHTML='';
  let sum = {k18:0, p5:0, sisa:0, totalQty:0};

  getInputRows().forEach(r=>{
    const total = r.qty.M + r.qty.L + r.qty.XL; // total semua size
    sum.totalQty += total;

    ['M','L','XL'].forEach(size=>{
      let q = r.qty[size];
      if(q>0){
        let h = calcWithPlastic(q);
        sum.k18 += h.k18;
        sum.p5 += h.p5;
        sum.sisa += h.sisa;

        tb.insertAdjacentHTML('beforeend',`
<tr>
<td>${r.alokasi} (${size})</td>
<td>${total}</td>
<td><span class="badge badge-koli18">${h.k18}</span></td>
<td><span class="badge badge-plastic">${h.p5}</span></td>
<td><span class="badge badge-sisa">${h.sisa}</span></td>
<td>${h.qk18}</td>
<td>${h.qp5}</td>
<td>${h.qs}</td>
</tr>`);
      }
    });
  });

  renderSummary([
    {l:'Total Qty (M+L+XL)',v:sum.totalQty,c:'badge-primary'},
    {l:'Koli 18',v:sum.k18,c:'badge-koli18'},
    {l:'Plastic 5',v:sum.p5,c:'badge-plastic'},
    {l:'Koli Sisa',v:sum.sisa,c:'badge-sisa'}
  ]);
}


function generateWithoutPlastic(){
  lastMode='without'; renderHeader('without');
  const tb=document.querySelector('#resultTable tbody');
  tb.innerHTML='';
  let sum = {k18:0, sisa:0, totalQty:0};

  getInputRows().forEach(r=>{
    const total = r.qty.M + r.qty.L + r.qty.XL;
    sum.totalQty += total;

    ['M','L','XL'].forEach(size=>{
      let q = r.qty[size];
      if(q>0){
        let h = calcWithoutPlastic(q);
        sum.k18 += h.k18;
        sum.sisa += h.sisa;

        tb.insertAdjacentHTML('beforeend',`
<tr>
<td>${r.alokasi} (${size})</td>
<td>${total}</td>
<td><span class="badge badge-koli18">${h.k18}</span></td>
<td><span class="badge badge-sisa">${h.sisa}</span></td>
<td>${h.qk18}</td>
<td>${h.qs}</td>
</tr>`);
      }
    });
  });

  renderSummary([
    {l:'Total Qty (M+L+XL)',v:sum.totalQty,c:'badge-primary'},
    {l:'Koli 18',v:sum.k18,c:'badge-koli18'},
    {l:'Koli Sisa',v:sum.sisa,c:'badge-sisa'}
  ]);
}


function renderSummary(arr){
  const box=document.getElementById('summaryBox');
  const c=document.getElementById('summaryContent');
  c.innerHTML='';
  arr.forEach(i=>{
    c.insertAdjacentHTML('beforeend',
      `<div class="summary-item ${i.c}">${i.l}: ${i.v}</div>`
    );
  });
  box.style.display='block';
}

document.addEventListener('input',e=>{
  if(e.target.closest('#tableInputDiv')||e.target===txtInput){
    if(lastMode==='with') generateWithPlastic();
    if(lastMode==='without') generateWithoutPlastic();
  }
});

function exportExcel(){
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.table_to_sheet(resultTable,{raw:true});
  XLSX.utils.book_append_sheet(wb,ws,'Packing');
  XLSX.writeFile(wb,
    lastMode==='with'?'packing_with_plastic.ods':'packing_without_plastic.ods'
  );
}

function resetAll(){
  document.querySelector('#tableInputDiv tbody').innerHTML=
  `<tr><td><input class="form-control"></td>
  <td><input type="number" class="form-control"></td>
  <td><input type="number" class="form-control"></td>
  <td><input type="number" class="form-control"></td></tr>`;
  document.querySelector('#resultTable tbody').innerHTML='';
  document.querySelector('#resultTable thead').innerHTML='';
  document.getElementById('summaryBox').style.display='none';
  txtInput.value=''; lastMode=null;
}

document.getElementById('downloadTemplate').addEventListener('click', function() {
    const data = [
        ["Alokasi","Qty M","Qty L","Qty XL"],
        ["ALOKASI 1","","",""],
        ["ALOKASI 2","","",""],
        ["ALOKASI 3","","",""]
    ];
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, "Template");
    XLSX.writeFile(wb, "template_label.ods", { bookType: "ods" });
});

fileInput.addEventListener('change', function(e){
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();

  if(file.name.endsWith('.txt')){
    reader.onload = () => {
      txtInput.value = reader.result;
      if(mode==='table') toggleInputBtn.click();
    };
    reader.readAsText(file);
    return;
  }

  reader.onload = function(evt){
    const data = new Uint8Array(evt.target.result);
    const wb = XLSX.read(data,{type:'array'});
    const sheetName = wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(ws,{header:1, defval:''});
    const cleanRows = rows.slice(1).filter(r => r[0]);

    if(mode==='txt'){
      txtInput.value = cleanRows.map(r=>`${r[0]},${r[1]||0},${r[2]||0},${r[3]||0}`).join('\n');
    }else{
      const tbody=document.querySelector('#tableInputDiv tbody');
      tbody.innerHTML='';
      cleanRows.forEach(r=>{
        tbody.insertAdjacentHTML('beforeend',`
          <tr>
            <td><input class="form-control" value="${r[0]}"></td>
            <td><input type="number" class="form-control" value="${r[1]||0}"></td>
            <td><input type="number" class="form-control" value="${r[2]||0}"></td>
            <td><input type="number" class="form-control" value="${r[3]||0}"></td>
          </tr>
        `);
      });
    }

    if(lastMode==='with') generateWithPlastic();
    if(lastMode==='without') generateWithoutPlastic();
  };

  reader.readAsArrayBuffer(file);
});

function addTableRow(){
  const tbody=document.querySelector('#tableInputDiv tbody');
  tbody.insertAdjacentHTML('beforeend',`
    <tr>
      <td><input class="form-control"></td>
      <td><input type="number" class="form-control"></td>
      <td><input type="number" class="form-control"></td>
      <td><input type="number" class="form-control"></td>
    </tr>
  `);
}

</script>
</body>
</html>
