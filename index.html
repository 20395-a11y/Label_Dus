<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Generator Alokasi Koli</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root {
  --bg: #f7f2f6ff;
  --card: #ffffff;
  --text: #000;
}
body.dark {
  --bg: #121212;
  --card: #1e1e1e;
  --text: #fff;
}
body {
  background: var(--bg);
  color: var(--text);
}

.container {
  background: var(--card);
  padding: 16px;
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,.1);
}

/* ===== SCROLL AREA ===== */
.table-scroll {
  max-height: 260px;
  overflow-y: auto;
  border-radius: 8px;
}

.table-scroll thead th {
  position: sticky;
  top: 0;
  z-index: 2;
}

table { font-size: 14px; }
td, th { vertical-align: middle; }
</style>
</head>

<body>
<div class="container my-3">

<h3 class="text-center mb-3">üì¶ Generator Alokasi Koli</h3>

<div class="d-flex gap-2 mb-3 flex-wrap">
  <button class="btn btn-secondary" onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>
  <button class="btn btn-success" onclick="fileInput.click()">Upload File</button>
  <button class="btn btn-primary" onclick="generateData()">Generate</button>
  <button class="btn btn-warning" onclick="exportExcel()">Export Excel</button>
  <button class="btn btn-danger" onclick="resetAll()">Reset</button>
</div>

<input type="file" id="fileInput" accept=".csv,.txt,.xls,.xlsx,.ods" hidden>

<!-- INPUT TABLE -->
<h5>Input Alokasi</h5>
<div class="table-scroll mb-3">
<table class="table table-bordered" id="inputTable">
<thead class="table-primary">
<tr>
<th>Alokasi</th>
<th width="120">Qty</th>
</tr>
</thead>
<tbody>
<tr>
<td><input class="form-control" placeholder="ALOKASI 1"></td>
<td><input type="number" class="form-control" placeholder="44"></td>
</tr>
</tbody>
</table>
</div>

<!-- RESULT TABLE -->
<h5>Hasil & Packing List</h5>
<div class="table-scroll">
<table class="table table-bordered" id="resultTable">
<thead class="table-primary">
<tr>
<th>Alokasi</th>
<th>Total</th>
<th>Koli 18</th>
<th>Plastik 5</th>
<th>Koli Sisa</th>
<th>Detail Packing</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<p class="mt-3">
üìå <b>File harus berisi 2 kolom: Alokasi | Qty (tanpa header)</b>
</p>

</div>

<script>
// ================= THEME =================
function toggleTheme() {
  document.body.classList.toggle('dark');
}

// ================= FILE UPLOAD =================
fileInput.addEventListener('change', handleFile);

function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = evt => {
    const data = new Uint8Array(evt.target.result);
    const wb = XLSX.read(data, { type: 'array' });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
    fillInput(rows);
  };
  reader.readAsArrayBuffer(file);
}

function fillInput(rows) {
  const tbody = document.querySelector('#inputTable tbody');
  tbody.innerHTML = '';
  rows.forEach(r => {
    if (!r[0] || isNaN(r[1])) return;
    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td><input class="form-control" value="${r[0]}"></td>
        <td><input type="number" class="form-control" value="${r[1]}"></td>
      </tr>
    `);
  });
}

// ================= HITUNG =================
function hitungKoli(qty) {
  const koli18 = Math.floor(qty / 18);
  let sisa = qty % 18;

  const plastik5 = Math.floor(sisa / 5);
  sisa = sisa % 5;

  return {
    koli18,
    plastik5,
    koliSisa: sisa > 0 ? 1 : 0,
    sisaQty: sisa
  };
}

function detailPacking(qty) {
  const h = hitungKoli(qty);
  return `
    ${h.koli18} koli x 18 = ${h.koli18 * 18}<br>
    ${h.plastik5} plastik x 5 = ${h.plastik5 * 5}<br>
    Sisa eceran = ${h.sisaQty}
  `;
}

// ================= GENERATE =================
function generateData() {
  const rows = document.querySelectorAll('#inputTable tbody tr');
  const tbody = document.querySelector('#resultTable tbody');
  tbody.innerHTML = '';

  rows.forEach(r => {
    const alokasi = r.cells[0].querySelector('input').value.trim();
    const qty = parseInt(r.cells[1].querySelector('input').value);

    if (!alokasi || qty <= 0) return;

    const h = hitungKoli(qty);

    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${alokasi}</td>
        <td>${qty}</td>
        <td>${h.koli18}</td>
        <td>${h.plastik5}</td>
        <td>${h.koliSisa}</td>
        <td>${detailPacking(qty)}</td>
      </tr>
    `);
  });
}

// ================= EXPORT =================
function exportExcel() {
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.table_to_sheet(resultTable, { raw: true });
  XLSX.utils.book_append_sheet(wb, ws, 'Packing List');
  XLSX.writeFile(wb, 'packing_list.xlsx');
}

// ================= RESET =================
function resetAll() {
  inputTable.querySelector('tbody').innerHTML = `
    <tr>
      <td><input class="form-control"></td>
      <td><input type="number" class="form-control"></td>
    </tr>`;

  resultTable.querySelector('tbody').innerHTML = '';

  // üî• FIX BUG UPLOAD ULANG
  document.getElementById('fileInput').value = '';
}

</script>

</body>
</html>
